<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 4 - Chains 鏈式調用</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            color: #333;
        }
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 10000;
        }
        .nav-title { font-size: 20px; font-weight: 700; color: #fff; }
        .nav-buttons { display: flex; gap: 12px; }
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.4); }
        .slide-container { width: 100%; height: 100vh; padding-top: 60px; position: relative; }
        .slide {
            position: absolute;
            top: 60px; left: 0;
            width: 100%;
            height: calc(100vh - 60px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .slide.active { display: flex; opacity: 1; }
        .content-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            padding: 50px;
            max-width: 1400px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
        }
        h1 { color: #667eea; font-size: 52px; margin-bottom: 20px; text-align: center; }
        h2 { color: #667eea; font-size: 36px; margin-bottom: 30px; border-bottom: 3px solid #764ba2; padding-bottom: 10px; }
        h3 { color: #667eea; font-size: 24px; margin: 25px 0 15px 0; }
        p, li { font-size: 20px; line-height: 1.8; color: #444; margin-bottom: 12px; }
        code { background: #f0f2f5; padding: 3px 8px; border-radius: 6px; font-family: 'Consolas', monospace; color: #764ba2; font-weight: 600; }
        pre { background: #1e1e2e; color: #cdd6f4; padding: 25px; border-radius: 12px; overflow-x: auto; margin: 20px 0; font-size: 16px; line-height: 1.6; }
        .box { padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 5px solid; }
        .info { background: #ede9fe; border-color: #8b5cf6; }
        .warning { background: #fef3c7; border-color: #f59e0b; }
        .success { background: #d1fae5; border-color: #10b981; }
        .highlight { background: linear-gradient(120deg, #667eea 0%, #764ba2 100%); padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; }
        .concept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 25px; }
        .concept-card { background: #f8fafc; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0; transition: all 0.3s; }
        .concept-card:hover { transform: translateY(-5px); border-color: #667eea; }
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(118, 75, 162, 0.8);
            color: white;
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            cursor: pointer;
            z-index: 9000;
            transition: all 0.3s;
        }
        .nav-arrow:hover { background: #764ba2; transform: translateY(-50%) scale(1.1); }
        .prev-arrow { left: 30px; }
        .next-arrow { right: 30px; }
        .indicators { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 4000; padding: 10px 20px; background: rgba(0,0,0,0.3); border-radius: 30px; }
        .dot { width: 12px; height: 12px; background: rgba(255,255,255,0.4); border-radius: 50%; cursor: pointer; transition: all 0.3s; }
        .dot.active { background: #764ba2; transform: scale(1.3); }
        .flow-diagram { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 30px 0; flex-wrap: wrap; }
        .flow-box { background: #667eea; color: white; padding: 15px 25px; border-radius: 10px; font-weight: bold; }
        .flow-arrow { font-size: 24px; color: #764ba2; }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-title">Unit 4 - Chains 鏈式調用</div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="goToSlide(0)">首頁</button>
            <button class="nav-btn" onclick="toggleFullscreen()">全螢幕</button>
            <a href="https://www.facebook.com/?locale=zh_TW" target="_blank" class="nav-btn">FB</a>
            <a href="https://www.youtube.com/@Liang-yt02" target="_blank" class="nav-btn">YT</a>
        </div>
    </div>

    <div class="slide-container">
        <!-- Slide 1: 封面 -->
        <div class="slide active">
            <div class="content-card" style="text-align: center;">
                <p style="color: #764ba2; font-size: 18px; letter-spacing: 3px;">PYTHON + LANGCHAIN 實戰課程</p>
                <h1>Unit 4: Chains 鏈式調用</h1>
                <p style="font-size: 24px; color: #666; margin-top: 20px;">組合元件，建立強大的 AI 處理流程</p>
                <div style="margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <span class="highlight">LCEL</span>
                    <span class="highlight">RunnableSequence</span>
                    <span class="highlight">RunnableParallel</span>
                </div>
            </div>
        </div>

        <!-- Slide 2: 什麼是 Chain -->
        <div class="slide">
            <div class="content-card">
                <h2>什麼是 Chain？</h2>
                <p>Chain 是將多個元件串聯起來的管道，前一個元件的輸出是下一個元件的輸入。</p>
                <div class="flow-diagram">
                    <div class="flow-box">Prompt</div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-box">LLM</div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-box">Parser</div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-box">結果</div>
                </div>
                <div class="box info">
                    <strong>LCEL (LangChain Expression Language)：</strong>使用 <code>|</code> 運算子串聯元件，語法簡潔直觀。
                </div>
            </div>
        </div>

        <!-- Slide 3: 基本 Chain -->
        <div class="slide">
            <div class="content-card">
                <h2>基本 Chain 建立</h2>
                <pre><code>from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

# 元件準備
prompt = ChatPromptTemplate.from_messages([
    ("system", "你是資料分析專家"),
    ("human", "分析這段數據：{data}")
])

llm = ChatOpenAI(model="gpt-3.5-turbo")
parser = StrOutputParser()

# 使用 | 建立 Chain
chain = prompt | llm | parser

# 執行 Chain
result = chain.invoke({
    "data": "Q1 營收 100 萬，Q2 營收 150 萬，Q3 營收 120 萬"
})
print(result)</code></pre>
            </div>
        </div>

        <!-- Slide 4: RunnablePassthrough -->
        <div class="slide">
            <div class="content-card">
                <h2>RunnablePassthrough 傳遞原始輸入</h2>
                <pre><code>from langchain_core.runnables import RunnablePassthrough

# 有時候需要在 Chain 中保留原始輸入
chain = (
    {
        "original": RunnablePassthrough(),  # 保留原始輸入
        "analysis": prompt | llm | parser   # 分析結果
    }
)

result = chain.invoke("台積電股價分析")
print(result["original"])   # 原始輸入
print(result["analysis"])   # AI 分析結果</code></pre>
                <div class="box success">
                    <strong>用途：</strong>當你需要同時保留原始數據和 AI 處理結果時使用。
                </div>
            </div>
        </div>

        <!-- Slide 5: RunnableParallel -->
        <div class="slide">
            <div class="content-card">
                <h2>RunnableParallel 並行處理</h2>
                <pre><code>from langchain_core.runnables import RunnableParallel

# 定義多個分析任務
sentiment_chain = sentiment_prompt | llm | parser
summary_chain = summary_prompt | llm | parser
keywords_chain = keywords_prompt | llm | parser

# 並行執行多個 Chain
parallel_chain = RunnableParallel(
    sentiment=sentiment_chain,
    summary=summary_chain,
    keywords=keywords_chain
)

# 一次調用，三個分析同時進行
result = parallel_chain.invoke({"text": "這家餐廳服務很好，但價格偏高"})

print(result["sentiment"])  # 情緒分析
print(result["summary"])    # 摘要
print(result["keywords"])   # 關鍵字</code></pre>
            </div>
        </div>

        <!-- Slide 6: 實作：數據分析 Chain -->
        <div class="slide">
            <div class="content-card">
                <h2>實作：完整數據分析 Chain</h2>
                <pre><code>from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import JsonOutputParser

# Step 1: 數據清理提示詞
clean_prompt = ChatPromptTemplate.from_template(
    "將以下原始數據整理成 JSON 格式：\n{raw_data}"
)

# Step 2: 數據分析提示詞
analyze_prompt = ChatPromptTemplate.from_template(
    "分析以下 JSON 數據，找出趨勢和異常：\n{cleaned_data}"
)

# Step 3: 報告生成提示詞
report_prompt = ChatPromptTemplate.from_template(
    "根據分析結果生成摘要報告：\n{analysis}"
)

# 組合完整 Chain
full_chain = (
    {"raw_data": RunnablePassthrough()}
    | clean_prompt | llm | StrOutputParser()
    | {"cleaned_data": RunnablePassthrough()}
    | analyze_prompt | llm | StrOutputParser()
    | {"analysis": RunnablePassthrough()}
    | report_prompt | llm | StrOutputParser()
)</code></pre>
            </div>
        </div>

        <!-- Slide 7: Chain 加入條件判斷 -->
        <div class="slide">
            <div class="content-card">
                <h2>RunnableBranch 條件分支</h2>
                <pre><code>from langchain_core.runnables import RunnableBranch

# 定義不同類型的處理 Chain
stock_chain = stock_prompt | llm | parser
food_chain = food_prompt | llm | parser
default_chain = general_prompt | llm | parser

# 建立條件分支
branch_chain = RunnableBranch(
    # (條件函式, 對應的 Chain)
    (lambda x: "股票" in x["topic"], stock_chain),
    (lambda x: "餐廳" in x["topic"], food_chain),
    default_chain  # 預設 Chain
)

# 根據輸入自動選擇處理方式
result1 = branch_chain.invoke({"topic": "台積電股票分析"})
result2 = branch_chain.invoke({"topic": "鼎泰豐餐廳評價"})</code></pre>
            </div>
        </div>

        <!-- Slide 8: 實作練習 -->
        <div class="slide">
            <div class="content-card">
                <h2>實作練習：多功能分析器</h2>
                <pre><code># 建立一個可以處理不同類型數據的 Chain
from langchain_core.runnables import RunnableParallel

def create_analysis_chain():
    # 情緒分析
    sentiment_prompt = ChatPromptTemplate.from_template(
        "分析以下文字的情緒（正面/負面/中性）：{text}"
    )
    # 關鍵字提取
    keyword_prompt = ChatPromptTemplate.from_template(
        "提取以下文字的 3 個關鍵字：{text}"
    )
    # 摘要生成
    summary_prompt = ChatPromptTemplate.from_template(
        "用一句話摘要以下內容：{text}"
    )

    return RunnableParallel(
        sentiment=sentiment_prompt | llm | StrOutputParser(),
        keywords=keyword_prompt | llm | StrOutputParser(),
        summary=summary_prompt | llm | StrOutputParser()
    )

analyzer = create_analysis_chain()
result = analyzer.invoke({"text": "您的文字內容"})</code></pre>
            </div>
        </div>

        <!-- Slide 9: 總結 -->
        <div class="slide">
            <div class="content-card">
                <h2>Unit 4 總結</h2>
                <div class="concept-grid">
                    <div class="concept-card">
                        <h3>LCEL 語法</h3>
                        <p>使用 <code>|</code> 串聯元件</p>
                    </div>
                    <div class="concept-card">
                        <h3>RunnablePassthrough</h3>
                        <p>保留原始輸入傳遞</p>
                    </div>
                    <div class="concept-card">
                        <h3>RunnableParallel</h3>
                        <p>並行執行多個任務</p>
                    </div>
                    <div class="concept-card">
                        <h3>RunnableBranch</h3>
                        <p>條件分支處理</p>
                    </div>
                </div>
                <div class="box info" style="margin-top: 30px;">
                    <strong>下一單元：</strong>實作專案 - 台灣餐廳美食 AI 分析系統
                </div>

                <p style="text-align: center; margin-top: 20px;">
                    <a href="index.html" style="color: #667eea; text-decoration: none; font-size: 1rem;">
                        ← 返回課程首頁
                    </a>
                </p>
            </div>
        </div>
    </div>

    <button class="nav-arrow prev-arrow" onclick="changeSlide(-1)">❮</button>
    <button class="nav-arrow next-arrow" onclick="changeSlide(1)">❯</button>
    <div class="indicators" id="indicators"></div>

    <script>
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;

        function init() {
            createIndicators();
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') changeSlide(-1);
                if (e.key === 'ArrowRight') changeSlide(1);
            });
        }

        function createIndicators() {
            const container = document.getElementById('indicators');
            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot' + (i === 0 ? ' active' : '');
                dot.onclick = () => goToSlide(i);
                container.appendChild(dot);
            }
        }

        function showSlide(index) {
            slides.forEach(s => s.classList.remove('active'));
            slides[index].classList.add('active');
            document.querySelectorAll('.dot').forEach((d, i) => {
                d.classList.toggle('active', i === index);
            });
            currentSlide = index;
        }

        function changeSlide(dir) {
            let newIndex = currentSlide + dir;
            if (newIndex >= 0 && newIndex < totalSlides) showSlide(newIndex);
        }

        function goToSlide(index) { showSlide(index); }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        init();
    </script>
</body>
</html>
